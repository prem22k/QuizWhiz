rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Quizzes Collection
     * - Create: Allow any authenticated user (Anonymous included).
     * - Update/Delete: Only the owner.
     * - Read: Public (Allow anyone to view/join).
     */
    match /quizzes/{quizId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Participants Subcollection
     * - Stores players joining a quiz.
     * - Requirement: "Allow anyone to create/read".
     * - Since players join via code without necessarily being signed up (guest join),
     *   we allow public write access here implicitly for "joining" and "submitting answers".
     */
    match /quizzes/{quizId}/participants/{participantId} {
      allow read: if true;
      allow write: if request.auth != null && (
        request.auth.uid == participantId ||
        request.auth.uid == get(/databases/$(database)/documents/quizzes/$(quizId)).data.ownerId
      );
      match /scores/{scoreId} {
        allow read, create, update: if true;
      }
    }

    /**
     * @description Questions Subcollection
     * - Read: Public (so client can render game).
     * - Write: Only Owner/Admin? The user didn't specifying "questions" rules update, 
     *   but logically the Creator (Host) needs to write questions on start.
     *   Since Quizzes Rule is "Owner Update", we should extend that here.
     *   But wait, the user's "createQuickGame" writes questions to subcollection.
     *   So the Host needs Create access to questions.
     */
    match /quizzes/{quizId}/questions/{questionId} {
       allow read: if true;
       
       allow create, update, delete: if request.auth != null && 
         get(/databases/$(database)/documents/quizzes/$(quizId)).data.ownerId == request.auth.uid;
    }
    match /admins/{adminId} {
      allow read: if request.auth.token.email != null && resource.data.email == request.auth.token.email;
      allow create: if request.auth.token.email != null
        && request.resource.data.email == request.auth.token.email
        && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    match /roles_admin/{userId} {
        allow read: if request.auth != null && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        allow write: if false; 
    }
  }
}